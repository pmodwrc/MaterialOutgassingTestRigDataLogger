{% extends "base.html" %}
{% block title %}Measurement Dashboard{% endblock %}

{% block content %}
<div class="container py-3">
  <h1 class="mb-3">Material Outgassing Test Rig</h1>

  <!-- Connect to instrument -->
  <section class="mb-4 p-3 border rounded">
    <h3>Connect to instrument</h3>
    <form method="post" class="form-inline">
      <label class="mr-2" for="device_type">Model</label>
      <select class="mr-2" name="device_type" id="device_type">
        <option value="Keithley2000">Keithley2000</option>
        <option value="KeysightDAQ970A">KeysightDAQ970A</option>
      </select>
      <label class="mr-2" for="instrument_address">Address</label>
      <select class="mr-2" name="instrument_address" id="instrument_address">
        {% for addr in instruments %}
        <option value="{{ addr }}">{{ addr }}</option>
        {% endfor %}
      </select>
      <button name="action" value="connect" class="btn btn-primary">Connect</button>
    </form>
  </section>

  <!-- Measurements -->
  <section class="mb-4 p-3 border rounded">
    <h3>Measurements</h3>
    <div class="mb-2">
      <form method="post" class="d-inline">
        <button name="action" value="start" class="btn btn-success">Start</button>
      </form>
      <form method="post" class="d-inline">
        <button name="action" value="stop" class="btn btn-warning">Stop</button>
      </form>
      <form method="post" class="d-inline">
        <button name="action" value="clear" class="btn btn-danger">Clear</button>
      </form>
      <a class="btn btn-outline-secondary" href="{{ url_for('views.export_csv') }}">Save CSV</a>
      <a class="btn btn-outline-secondary" href="{{ url_for('views.chart_png') }}" target="_blank">Open Chart</a>
    </div>
    <div>
      <img src="{{ url_for('views.chart_png') }}" alt="chart" style="max-width:100%" />
    </div>
    <div class="mt-2">
      <strong>Status:</strong> {{ 'Running' if state.is_measuring else 'Stopped' }}
    </div>
  </section>

  <!-- Configure channels -->
  <section class="mb-4 p-3 border rounded">
    <h3>Configure channels</h3>
    <form method="post">
      <div class="table-responsive">
        <table class="table table-sm">
          <thead><tr><th>Active</th><th>Channel</th><th>Name</th><th>Config</th></tr></thead>
          <tbody>
          {% for i in range(1, state.number_of_channels + 1) %}
            <tr>
              <td><input type="checkbox" name="channel_{{ i }}" {% if state.channel_active[i] %}checked{% endif %} /></td>
              <td>CH{{ i }}</td>
              <td><input type="text" name="name_{{ i }}" value="{{ state.channel_name[i] }}"/></td>
              <td>
                <select name="config_{{ i }}">
                  {% for opt in channel_options %}
                  <option value="{{ opt }}" {% if state.channel_config[i]==opt %}selected{% endif %}>{{ opt }}</option>
                  {% endfor %}
                </select>
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="form-inline">
        <label class="mr-2" for="config_file">Load preset</label>
        <select class="mr-2" name="config_file" id="config_file">
          {% for cfg in config_files %}
          <option value="{{ cfg }}">{{ cfg }}</option>
          {% endfor %}
        </select>
        <button name="action" value="load_config_file" class="btn btn-outline-info mr-2">Load</button>
        <button name="action" value="save_channels" class="btn btn-primary">Save Channels</button>
      </div>
    </form>
  </section>

  <!-- Save measurements -->
  <section class="mb-4 p-3 border rounded">
    <h3>Save measurements</h3>
    <a class="btn btn-outline-secondary" href="{{ url_for('views.export_csv') }}">Save as CSV</a>
    <a class="btn btn-outline-secondary" href="{{ url_for('views.chart_png') }}" target="_blank">Save chart (open image)</a>
  </section>
</div>

{% endblock %}
