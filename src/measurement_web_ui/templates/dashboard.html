{% extends "base.html" %}
{% block title %}Measurement Dashboard{% endblock %}

{% block content %}
<div class="container py-3">
  <h1 class="mb-3">Material Outgassing Test Rig</h1>

  <!-- Connect to instrument -->
  <section class="mb-4 p-3 border rounded">
    <h3>Connect to instrument</h3>
    <form method="post" class="form-inline">
      <label class="mr-2" for="device_type">Model</label>
      <select class="mr-2" name="device_type" id="device_type">
        {% for device_type in device_types %}
        <option value="{{ device_type }}" {% if selected_device_type == device_type %}selected{% endif %}>{{ device_type }}</option>
        {% endfor %}
      </select>
      <label class="mr-2" for="instrument_address">Address</label>
      <select class="mr-2" name="instrument_address" id="instrument_address">
        {% for addr in instruments %}
        <option value="{{ addr }}" {% if selected_address == addr %}selected{% endif %}>{{ addr }}</option>
        {% endfor %}
      </select>
      <button id="connectBtn" name="action" value="connect" type="submit" class="btn {% if instrument %}btn-success{% else %}btn-primary{% endif %}" {% if instrument %}disabled{% endif %}>
        {% if instrument %}Connected{% else %}Connect{% endif %}
      </button>
    </form>
  </section>

  <script>
    const modelSel = document.getElementById('device_type');
    const addrSel = document.getElementById('instrument_address');
    const connectBtn = document.getElementById('connectBtn');

    function markDisconnected() {
      if (connectBtn) {
        connectBtn.removeAttribute('disabled');
        connectBtn.classList.remove('btn-success');
        connectBtn.classList.add('btn-primary');
        connectBtn.textContent = 'Connect';
        // ensure it posts the connect action
        connectBtn.name = 'action';
        connectBtn.value = 'connect';
        connectBtn.type = 'submit';
      }
    }

    function postSelection() {
      // Immediately flip UI to disconnected so the next click works without waiting
      markDisconnected();
      fetch('{{ url_for('views.selection_changed') }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          device_type: modelSel.value,
          instrument_address: addrSel.value
        })
      });
    }

    modelSel && modelSel.addEventListener('change', postSelection);
    addrSel && addrSel.addEventListener('change', postSelection);
  </script>

  <!-- Unified measurement + channel form -->
  <form method="post" id="mainForm">
    <!-- Measurements -->
    <section class="mb-4 p-3 border rounded">
      <h3>Measurements</h3>
      <div class="mb-2">
        <button name="action" value="start" id="startBtn" class="btn btn-success" {% if not instrument or not state.has_active %}disabled{% endif %}>Start</button>
        <button name="action" value="stop" class="btn btn-warning">Stop</button>
        <button name="action" value="clear" class="btn btn-danger">Clear</button>
        <a class="btn btn-outline-secondary" href="{{ url_for('views.export_csv') }}">Save CSV</a>
        <a class="btn btn-outline-secondary" href="{{ url_for('views.chart_png') }}" target="_blank">Open Chart</a>
      </div>
      <div>
        <img src="{{ url_for('views.chart_png') }}" alt="chart" style="max-width:100%" />
      </div>
      <div class="mt-2">
        <strong>Status:</strong> {{ 'Running' if state.is_measuring else 'Stopped' }}
      </div>
    </section>

    <!-- Configure channels -->
    <section class="mb-4 p-3 border rounded">
      <h3>Configure channels</h3>
      <div class="table-responsive">
        <table class="table table-sm">
          <thead><tr><th>Active</th><th>Channel</th><th>Name</th><th>Config</th></tr></thead>
          <tbody>
          {% for i in range(1, state.number_of_channels + 1) %}
            <tr>
              <td><input type="checkbox" class="ch-active" name="channel_{{ i }}" {% if state.channel_active[i] %}checked{% endif %} /></td>
              <td>CH{{ i }}</td>
              <td><input type="text" name="name_{{ i }}" value="{{ state.channel_name[i] }}"/></td>
              <td>
                <select name="config_{{ i }}" class="cfg-select">
                  {% for opt in channel_options %}
                  <option value="{{ opt }}" {% if state.channel_config[i]==opt %}selected{% endif %}>{{ opt }}</option>
                  {% endfor %}
                </select>
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="form-inline mb-2">
        <label class="mr-2" for="config_file">Load preset</label>
        <select class="mr-2" name="config_file" id="config_file">
          {% for cfg in config_files %}
          <option value="{{ cfg }}">{{ cfg }}</option>
          {% endfor %}
        </select>
        <button name="action" value="load_config_file" class="btn btn-outline-info mr-2">Load</button>
        <button name="action" value="save_channels" class="btn btn-primary">Save Channels</button>
      </div>
    </section>
  </form>

  <!-- Save measurements (export links outside form) -->
  <section class="mb-4 p-3 border rounded">
    <h3>Save measurements</h3>
    <a class="btn btn-outline-secondary" href="{{ url_for('views.export_csv') }}">Save as CSV</a>
    <a class="btn btn-outline-secondary" href="{{ url_for('views.chart_png') }}" target="_blank">Save chart (open image)</a>
  </section>
</div>

<script>
  // Live enable/disable Start button
  const startBtn = document.getElementById('startBtn');
  const activeBoxes = document.querySelectorAll('.ch-active');
  function refreshStartEnabled() {
    const anyActive = Array.from(activeBoxes).some(cb => cb.checked);
    const instrumentConnected = {{ 'true' if instrument else 'false' }};
    if (instrumentConnected && anyActive) {
      startBtn.removeAttribute('disabled');
    } else {
      startBtn.setAttribute('disabled', 'disabled');
    }
  }
  activeBoxes.forEach(cb => cb.addEventListener('change', refreshStartEnabled));
  refreshStartEnabled();
</script>

{% endblock %}
